%% Copernicus Publications Manuscript Preparation Template for LaTeX Submissions
%% ---------------------------------
%% This template should be used for copernicus.cls
%% The class file and some style files are bundled in the Copernicus Latex Package, which can be downloaded from the different journal webpages.
%% For further assistance please contact Copernicus Publications at: production@copernicus.org
%% https://publications.copernicus.org/for_authors/manuscript_preparation.html


%% Please use the following documentclass and journal abbreviations for preprints and final revised papers.

%% 2-column papers and preprints
\documentclass[gmd, manuscript]{copernicus}
%\documentclass[gmd, manuscript,draft]{copernicus}

%% Journal abbreviations (please use the same for preprints and final revised papers)

% Advances in Geosciences (adgeo)
% Advances in Radio Science (ars)
% Advances in Science and Research (asr)
% Advances in Statistical Climatology, Meteorology and Oceanography (ascmo)
% Annales Geophysicae (angeo)
% Archives Animal Breeding (aab)
% ASTRA Proceedings (ap)
% Atmospheric Chemistry and Physics (acp)
% Atmospheric Measurement Techniques (amt)
% Biogeosciences (bg)
% Climate of the Past (cp)
% DEUQUA Special Publications (deuquasp)
% Drinking Water Engineering and Science (dwes)
% Earth Surface Dynamics (esurf)
% Earth System Dynamics (esd)
% Earth System Science Data (essd)
% E&G Quaternary Science Journal (egqsj)
% European Journal of Mineralogy (ejm)
% Fossil Record (fr)
% Geochronology (gchron)
% Geographica Helvetica (gh)
% Geoscience Communication (gc)
% Geoscientific Instrumentation, Methods and Data Systems (gi)
% Geoscientific Model Development (gmd)
% History of Geo- and Space Sciences (hgss)
% Hydrology and Earth System Sciences (hess)
% Journal of Bone and Joint Infection (jbji)
% Journal of Micropalaeontology (jm)
% Journal of Sensors and Sensor Systems (jsss)
% Magnetic Resonance (mr)
% Mechanical Sciences (ms)
% Natural Hazards and Earth System Sciences (nhess)
% Nonlinear Processes in Geophysics (npg)
% Ocean Science (os)
% Primate Biology (pb)
% Proceedings of the International Association of Hydrological Sciences (piahs)
% Scientific Drilling (sd)
% SOIL (soil)
% Solid Earth (se)
% The Cryosphere (tc)
% Weather and Climate Dynamics (wcd)
% Web Ecology (we)
% Wind Energy Science (wes)


%% \usepackage commands included in the copernicus.cls:
%\usepackage[german, english]{babel}
%\usepackage{tabularx}
%\usepackage{cancel}
%\usepackage{multirow}
%\usepackage{supertabular}
%\usepackage{algorithmic}
%\usepackage{algorithm}
%\usepackage{amsthm}
%\usepackage{float}
%\usepackage{subfig}
%\usepackage{rotating}

%Additional packages:
\usepackage{mathrsfs} %provides calligraphic Fonts
\usepackage{placeins}
\usepackage[percent]{overpic}
\allowdisplaybreaks

\graphicspath{
%{./figures/common/}
%{./figures/v_10_13_solitary/}
{./figures/}
}

\newcommand{\onur}[1]{\textcolor{blue}{\{Onur: #1\}}}
\newcommand{\markus}[1]{\textcolor{blue}{\{Markus: #1\}}}

\begin{document}
\title{FABM-NflexPD 2.0: Testing an Instantaneous Acclimation Approach for Modelling the Implications of Phytoplankton Eco-physiology for the Carbon and Nutrient cycles}

% \Author[affil]{given_name}{surname}

\Author[1]{Onur}{Kerimoglu}
\Author[2]{Markus}{Pahlow}
\Author[3,a]{Prima}{Anugerahanti}
\Author[3]{S. Lan}{Smith}

\affil[1]{Institute for Chemistry and Biology of the Marine Environment, University of Oldenburg, Oldenburg, Germany}
\affil[2]{GEOMAR Helmholtz Centre for Ocean Research Kiel, Kiel, Germany}
\affil[3]{Earth SURFACE Research Center, Research Institute for Global Change, JAMSTEC, Yokosuka, Japan}
\affil[a]{Present address: Dept.\ of Earth, Ocean and Ecological Sciences, School of Environmental Sciences, University of Liverpool, Liverpool, United Kingdom}

%% The [] brackets identify the author with the corresponding affiliation. 1, 2, 3, etc. should be inserted.

%% If an author is deceased, please mark the respective author name(s) with a dagger, e.g. "\Author[2,$\dag$]{Anton}{Aman}", and add a further "\affil[$\dag$]{deceased, 1 July 2019}".

%% If authors contributed equally, please mark the respective author names with an asterisk, e.g. "\Author[2,*]{Anton}{Aman}" and "\Author[3,*]{Bradley}{Bman}" and add a further affiliation: "\affil[*]{These authors contributed equally to this work.}".


\correspondence{Onur Kerimoglu (kerimoglu.o@gmail.com)}

\runningtitle{FABM-NflexPD 2.0}

\runningauthor{Kerimoglu et al.}


\received{}
\pubdiscuss{} %% only important for two-stage journals
\revised{}
\accepted{}
\published{}

%% These dates will be inserted by Copernicus Publications during the typesetting process.


\firstpage{1}

\maketitle


\begin{abstract}
The acclimative response of phytoplankton, which adjusts their nutrient and pigment content in response to changes in ambient light, nutrient levels, and temperature, is an important determinant of observed chlorophyll distributions and biogeochemistry. Acclimative models typically capture this response and its impact on the C:nutrient:Chl ratios of phytoplankton by explicitly resolving the dynamics of these constituents of phytoplankton biomass. The Instantaneous Acclimation (IA) approach only requires resolving the dynamics of a single tracer and calculates the elemental composition assuming instantaneous local equilibrium.  IA can capture the acclimative response without substantial loss of accuracy in both 0D box models and spatially explicit 1D models.  A major draw-back of IA so far has been its inability to maintain mass balance for the elements with unresolved dynamics.  Here we extend the IA model to capture both C and N cycles in a 0D setup, which requires analytical derivation of additional flux terms to account for the temporal changes in cellular N quota, $Q$. We present extensive tests of this model, with regard to the conservation of total C an N, and its behavior in comparison to an otherwise equivalent, fully explicit Dynamic Acclimation (DA) variant, under idealized conditions with variable light and temperature. We also demonstrate a modular implementation of this model in the Framework for Aquatic Biogeochemical Modelling (FABM), which facilitates modelling competition between an arbitrary number of different acclimative phytoplankton types.  
%The IA variant is $\sim$10\% faster than the fully dynamic variant for 50 phytoplankton groups, but no clear improvement in computation speed is achieved for fewer groups.  
In a 0D setup, we did not find evidence for computational advantages of the IA approch over the DA variant.
In a spatially explicit setup, performance gains 
%for simulating a small number of phytoplankton groups 
may be possible, but requires modifications of the physical-flux calculations to account for spatial differences in $Q$ between model grid cells.
\end{abstract}


%\copyrightstatement{TEXT}

\clearpage
%INTRODUCTION
\introduction%% \introduction[modified heading if necessary]

Elemental stoichiometry and pigment density of phytoplankton exhibit strong variability across environmental conditions, at both the physiological \citep[e.g.,][]{Garcia2016}, and the community level \citep[e.g.,][]{MorenoMartiny2018}. The physiological flexibility is driven by an acclimative re-adjustment of cellular machinery to changes in the availability in nutrients and light, and the fact that the various cellular functions have competing requirements for resources, an example being enzymes, rich in N \citep{Geider2002}, needed for nutrient uptake and photosynthesis. The systematic differences in cellular composition between species may be explained by the typical composition of some species being better or worse suited than that of others for a given resource regime \citep{Klausmeier2004,Arrigo2005,Burson2016}.

The potential relevance of such variability in the cellular composition of phytoplankton for biogeochemical cycles has been recognized decades ago \citep{Redfield1934,Redfield1958}, and evidence has been building ever since \citep{Lenton2007,Bonachela2016,Pahlow2020}.  Accounting for the acclimative capacity of phytoplankton in models is relevant for predicting the response of ecosystems to environmental change \citep{Kwiatkowski2018,Kerimoglu2018} and for model performance \citep{Ayata2013, Kerimoglu2017, Chen2018a}.  It also can endow models with desirable properties, such as improved model portability \citep{Anugerahanti2021}. However, mechanistic acclimative models typically require additional state variables, usually one for chlorophyll and one for each of the resolved nutrients \citep[e.g.,][]{Geider1998, Flynn2003}, but possibly even more \citep{Bonachela2013, Wirtz2016, Inomura2020}.%\onur{Check again Inomura2020}.

However, additional state variables can increase the computational costs significantly in spatially explicit setups \citep{Fulton2003}, especially for models with 100s of phytoplankton groups \citep[e.g.,][]{Follows2007, Dutkiewicz2020}. As a potential remedy to this problem, the `Instantaneous Acclimation' (IA) approach can be used, where the changes in cellular composition are not dynamically tracked, but adjust instantaneously to the resource environment. For instance, the FlexPFT model \citep{Smith2016} follows an IA approach, where the Chl:C and C:N ratios instantaneously assume the optimal ratios for balanced growth \citep{Pahlowetal13}.  \citet{Ward2017} compared a fully explicit, classical Caperon/Droop model \citep{Caperon1968,Droop1968} to its IA counterpart, and found that across a range of environmental settings, the predictions of the two approaches matched closely in a 0D setup.  \citet{Kerimoglu2021} introduced FABM-NflexPD 1.0, a 1D setup of the FlexPFT model in the Framework of Aquatic Biogeochemical Models \citep[FABM,][]{Bruggeman2014} and showed that the predictions of the IA variant of the model largely matched those of the fully explicit `Dynamic Acclimation' (DA) counterpart, except for minor differences during the transitions from winter to spring and from autumn to winter.

FABM-NflexPD 1.0 only tracks N, which may be sufficient for some ecological applications, but not for applications that require mass balance for (multiple) nutrients and carbon.  Here we introduce FABM-NflexPD 2.0, which tracks both C and N\@.  We present a detailed description of a C-based version, which is extended to account also for N fluxes resulting from instantaneous changes in cell quotas, such that mass balance is maintained for both C and N\@.  We evaluate the consistency and robustness of the model by means of the following formal tests:
\begin{description}
 \item [T1] assessment of the conservation of C and N in a simplified version of the model in a 0D setup, where temperature and day length are held constant, and light is provided as a sinusoidal function of time of year
 \item [T2] test of the IA approach in a more realistic setup, where temperature and day length also vary over time, while also accounting for light attenuation by phytoplankton, and comparison against a fully explicit DA variant 
 \item [T3] simulation with multiple phytoplankton groups
 \item [T4] simulation in an open system where N and C are not conserved
 %\item [T4] \onur{done} application of the model in an idealistic 1D setup and assessment of mass conservation \textcolor{red}{\{Onur: this test failed: in 1D, model does not seem to be mass conservative, see Section~\ref{s.resT4}.\}}
\end{description}


% \begin{figure}[htb]
%   \centering
%   \includegraphics[width=12cm]{?.pdf}
%   \caption{\label{?}}
% \end{figure}

%MODEL DESCRIPTION
\section{Model Description}

%\markus{Do we need DOM?  Including DOC and DON in the detritus and reducing the rate of hydrolysis by 1/2 yields almost the same results.  So, in 0D including DOM makes no difference.}

FABM-NflexPD 2.0 differs from FABM-NflexPD 1.0 (K21) 
%in two major respects.  (1) The new version maintains mass balance for both C and N, instead of only N\@.  (2) We restrict this version to 0D for simplicity, which allows subsuming the DOM compartment in the detritus compartment, leaving 5 state variables to represent dissolved inorganic C and N (DIC and DIN), phytoplankton C ($\text{Phy}_{\text{C}}$), and detritus C and N ($\text{Det}_{\text{C}}$ and $\text{Det}_{\text{N}}$). 
mainly by tracing the dissolved inorganic carbon pool, DIC, such that now the model is ideally able to conserve both the total C and N in the system, and not only N as in K21. Moreover, we consider dilution/mixing and sinking terms for simulating an open system, such as a chemostat or a surface mixed layer (SML). As in K21, we consider here a DA variant to compare against the IA variant, but not a fixed stoichiometry variant unlike in K21. As a final difference, for the IA, we trace the C content in phytoplankton with a state variable, instead of the N content as in K21. The rates of change of the state variables are:

\begin{subequations}\label{eq:phy}
 \begin{flalign}
  \label{eq:sPhyC}
  %\frac{\mathrm{d}\, \text{Phy}_{\text{C}}}{\mathrm{d}\, t} &= \underbrace{F_{\text{DIC}-\text{Phy}_{\text{C}}}}_{\text{Net uptake}} - \underbrace{F_{\text{Phy}_{\text{C}}-\text{Det}_{\text{C}}}}_{\text{Mortality}} - \underbrace{D \cdot \text{Phy}_{\text{C}}}_{\text{Dilution}}\\
  \frac{\mathrm{d}\, \text{Phy}_{\text{C}}}{\mathrm{d}\, t} &= F_{\text{DIC}-\text{Phy}_{\text{C}}} - F_{\text{Phy}_{\text{C}}-\text{Det}_{\text{C}}} - D \cdot \text{Phy}_{\text{C}}\\
  \label{eq:sPhyN}
  \frac{\mathrm{d}\, \text{Phy}_{\text{N}}}{\mathrm{d}\, t} &= \underbrace{F_{\text{DIN}-\text{Phy}_{\text{N}}}}_{\text{Net uptake}} - \underbrace{F_{\text{Phy}_{\text{N}}-\text{Det}_{\text{N}}}}_{\text{Mortality}} - \underbrace{D \cdot \text{Phy}_{\text{N}}}_{\text{Dilution}} &  \{\text{DA}\}
 \end{flalign}
\end{subequations}
\begin{subequations}\label{eq:det}
  \begin{flalign}
  \label{eq:sDetC}
  \frac{\mathrm{d}\, \text{Det}_{\text{C}}}{\mathrm{d}\, t} &= F_{\text{Phy}_{\text{C}}-\text{Det}_{\text{C}}} - F_{\text{Det}_{\text{C}}-\text{DOC}}  - D \cdot \text{Det}_{\text{C}} - \frac{w_{\text{Det}}}{H_{\text{SML}}} \cdot \text{Det}_{\text{C}} \\
  \label{eq:sDetN}
  \frac{\mathrm{d}\, \text{Det}_{\text{N}}}{\mathrm{d}\, t} &= F_{\text{Phy}_{\text{N}}-\text{Det}_{\text{N}}} - \underbrace{F_{\text{Det}_{\text{N}}-\text{DON}}}_\textrm{Hydrolysis} - D \cdot \text{Det}_{\text{N}} - \underbrace{\frac{w_{\text{Det}}}{H_{\text{SML}}} \cdot \text{Det}_{\text{N}}}_{\text{Sinking}}
\end{flalign}
\end{subequations}
\begin{subequations}\label{eq:dom}
  \begin{align}
   \label{eq:doc}
   \frac{\mathrm{d}\, \text{DOC}}{\mathrm{d}\, t} &= F_{Det_{\text{C}}-DOC} - F_{DOC-DIC} - D \cdot \text{DOC}\\
   \label{eq:don}
   \frac{\mathrm{d}\, \text{DON}}{\mathrm{d}\, t} &= F_{Det_{\text{N}}-DON} - \underbrace{F_{DON-DIN}}_\textrm{Remineralization} - D \cdot \text{DON}
  \end{align}
\end{subequations}
\begin{subequations}\label{eq:dim}
\begin{flalign}
  \label{eq:dic}
  \frac{\mathrm{d}\, \text{DIC}}{\mathrm{d}\, t} &= F_{\text{DOC}-\text{DIC}} - F_{\text{DIC}-\text{Phy}_{\text{C}}} - D \cdot(\text{DIC}-\text{DIC}_{\text{in}}) \\
  \label{eq:sdin}
  \frac{\mathrm{d}\,\text{DIN}}{\mathrm{d}\,t} &= F_{\text{DON}-\text{DIN}} - F_{\text{DIN}-\text{Phy}_{\text{N}}} - D \cdot (\text{DIN}-\text{DIN}_{\text{in}})
\end{flalign}
\end{subequations}

\noindent where $F_{x-y}$ is the flux from $x$ to $y$, where $x$ and $y$ are state variables, except for $\text{Phy}_{\text{N}}$ in the IA variant, which is defined as:
\begin{equation}
  \label{eq:Q}
  \text{Phy}_{\text{N}} = \text{Phy}_{\text{C}} \cdot Q \hfill \{\text{IA}\}
\end{equation}
where $Q$ is the phytoplankton N quota (N:C ratio). Dilution and sinking terms describe fluxes in and out of the system, and are non-zero only for the test T4 (see below).

\subsection{C and N content of Phytoplankton}

As mentioned above, in this, C-based, version of the IA model variant, only the C content of phytoplankton ($\text{Phy}_{\text{C}}$) is dynamically tracked via Eq.~\eqref{eq:sPhyC}, whereas $\text{Phy}_{\text{N}}$ is defined as a function of $Q$ in Eq.~\eqref{eq:Q}.  $Q$ adjusts instantaneously to its optimal value for balanced growth, as determined by nutrient uptake in the protoplast, $\hat{V}_{\text{N}}$, and net photosynthesis in the chloroplast, $\hat{\mu}_{\text{net}}$ (Eq.~10 in K21):
\begin{equation}\label{eq:Qopt}
 Q = \frac{Q_{0}}{2} \left[1+\sqrt{1+\frac{2}{Q_{0}{({\hat{\mu}_{\text{net}}}/{\hat{V}_{\text{N}}}+\zeta_{\text{N}} )}}} \right] \hfill \{\text{IA}\}
\end{equation}
where $Q_{0}$ and $\zeta_{\text{N}}$ are the subsistence N quota, and cost of N uptake, respectively (Table~\ref{T.pars}). The first term in Eq.~\eqref{eq:sPhyC}, $F_{\text{DIC}-\text{Phy}_{\text{C}}}$, represents net phytoplankton growth:
\begin{equation}
  \label{eq:growth}
  F_{\text{DIC}-\text{Phy}_{\text{C}}} = \mu \cdot \text{Phy}_{\text{C}}
\end{equation}
% This term is used in this updated model version also to track the DIC concentration, which in turn enables tracing the total C in the system.
% Note that representing the C uptake and respiration terms with a lumped term $F_{\text{DIC}-\text{Phy}_{\text{C}}}$ in Eq.~\eqref{eq:dic} is based on the assumption that the respiration terms (see Eq.~7 in K21) are added back to DIC, and would have to be separated if CO2 was explicitly resolved. (M removed this because both C uptake and respiration are CO2 fluxes)
The second term in Eq.~\eqref{eq:sPhyC}, $F_{\text{Phy}_{\text{C}}-\text{Det}_{\text{C}}}$, represents the mortality of phytoplankton:
\begin{flalign}
  \label{eq:mortC}
  F_{\text{Phy}_{\text{C}}-\text{Det}_{\text{C}}} &= m_{\text{C}} \cdot \text{Phy}_{\text{C}}^2 \\
  \intertext{Its N counterpart is found by multiplication with $Q$:}
  \label{eq:mortN}
  F_{\text{Phy}_{\text{N}}-\text{Det}_{\text{N}}} &= F_{\text{Phy}_{\text{C}}-\text{Det}_{\text{C}}} \cdot Q
\end{flalign}
where $m_{\text{C}}$ [\unit{m^3\ mmolC^{-1}\ d^{-1}}] is the C-based specific mortality rate.
The hydrolysis and remineralization fluxes are calculated as first-order reactions:
\begin{flalign}
  \label{eq:remiC}
  F_{\text{Det}_{X}-\text{DO}X} &= r_{\text{hyd}} \cdot \text{Det}_{X}\ \text{,} \quad X\in\{\text{C, N}\} \\
  F_{\text{DO}X-\text{DI}X} &= r_{\text{rem}} \cdot \text{DO}X\ \text{,} \quad X\in\{\text{C, N}\}
\end{flalign}

%given by the division of N flux from phytoplankton to detritus, $F_{\text{Phy}_{\text{N}}-\text{Det}_{\text{N}}}$ by $Q$

\subsection{N fluxes between DIN and Phytoplankton}\label{S:DescFlux}
% The flux from DIN to $\text{Phy}_{\text{N}}$ given by phytoplankton N uptake, $V_{\text{N}}$:
% \begin{equation} \label{eq:dphyNdt}
%   F_{\text{DIN}-\text{Phy}_{\text{N}}} = V_{\text{N}} = F_{\text{DIC -- Phy}_{\text{C}}} \cdot Q = \mu \cdot \text{Phy}_{\text{C}} \cdot Q
% \end{equation}
% The rate of change of $\text{Phy}_{\text{N}}$ resulting from Eqs.~\eqref{eq:sPhyC} --~\eqref{eq:dim}  is the complement of the sum of Eqs.~\eqref{eq:sDetN},~\eqref{eq:don} and~\eqref{eq:sdin}, apart from the dilution and sinking terms for $\text{Det}_{\text{N}}$, DON and DIN, less the dilution of $\text{Phy}_{\text{N}}$:
% \begin{equation}
%   \label{eq:phyn_def}
%   \frac{\mathrm{d}\,\text{Phy}_{\text{N}}}{\mathrm{d}\,t} = F_{\text{DIN}-\text{Phy}_{\text{N}}} - F_{\text{Phy}_{\text{N}}-\text{Det}_{\text{N}}}  - D \cdot \text{Phy}_{\text{N}} = \frac{\mathrm{d}\,\text{Phy}_{\text{C}}}{\mathrm{d}\,t} \cdot Q
% \end{equation}
% However, $Q$ changes over time, which also contributes to the rate of change of $\text{Phy}_{\text{N}}$.  This becomes clear by differentiating the rate of change of $\text{Phy}_{\text{N}}$ via the product rule:
% \begin{equation}
%   \label{eq:phyn_def2}
%   \frac{\mathrm{d}\,\text{Phy}_{\text{N}}}{\mathrm{d}\,t} = \frac{\mathrm{d}\,(\text{Phy}_{\text{C}}\cdot Q)}{\mathrm{d}\,t}
%   = \frac{\mathrm{d}\,\text{Phy}_{\text{C}}}{\mathrm{d}\,t} \cdot Q + \text{Phy}_{\text{C}} \cdot \frac{\mathrm{d}\,Q}{\mathrm{d}\,t} \tag{\ref{eq:phyn_def}.2}
% \end{equation}
% Thus, the second term in the right-hand side of Eq.~\eqref{eq:phyn_def2}, $\text{Phy}_{\text{C}}\cdot \mathrm{d}\,Q / \mathrm{d}\, t$, is not accounted for by our system of Eqs.~\eqref{eq:sPhyC} --~\eqref{eq:dim} because $\text{Phy}_{\text{N}}$ is not a state variable.  Following \citet{Smith2016}, we subtract it from the differential equation for DIN\@:
For tracking the $\text{Phy}_{\text{N}}$ for the DA variant (Eq.~\ref{eq:sPhyN}), and the DIN for both variants (Eq.~\ref{eq:sdin}), the flux from DIN to $\text{Phy}_{\text{N}}$ needs to be known. As in K21, for the DA variant, it is simply the product of a specific uptake rate and the phytoplankton C biomass:
\begin{equation}
  \label{eq:Fdinphyn}
  F_{\text{DIN}-\text{Phy}_{\text{N}}} = V_{\text{N}} \cdot \text{Phy}_{\text{C}} \hfill \{\text{DA}\}
\end{equation}
For the IA variant, the exact value of this flux is unknown due to the non-existent $\text{Phy}_{\text{N}}$ pool, and the corresponding flux. By substituting $\text{Phy}_{\text{N}}$ with  $\text{Phy}_{\text{C}}\cdot Q$, and applying the product rule we get:
\begin{equation}
  \label{eq:sPhyN2}
  \frac{\mathrm{d}\,\text{Phy}_{\text{N}}}{\mathrm{d}\,t} = \frac{\mathrm{d}\,(\text{Phy}_{\text{C}}\cdot Q)}{\mathrm{d}\,t}
  = \frac{\mathrm{d}\,\text{Phy}_{\text{C}}}{\mathrm{d}\,t} \cdot Q + \text{Phy}_{\text{C}} \cdot \frac{\mathrm{d}\,Q}{\mathrm{d}\,t} \tag{\ref{eq:sPhyN}.2}
\end{equation}
here, the first term reflects the N equivalent of the change in $\text{Phy}_{\text{C}}$, i.e., Eq.~\eqref{eq:sPhyC}, and the second term describes the effect of the change in quota over time due to imbalances between C and N uptake. Substituting Eq.~\eqref{eq:sPhyC} in Eq.~\eqref{eq:sPhyN2}:
\begin{equation}
  \label{eq:sPhyN3}
  \frac{\mathrm{d}\,\text{Phy}_{\text{N}}}{\mathrm{d}\,t} = \left[ F_{\text{DIC}-\text{Phy}_{\text{C}}} \cdot Q - F_{\text{Phy}_{\text{C}}-\text{Det}_{\text{C}}} \cdot Q - D \cdot \text{Phy}_{\text{C}} \cdot Q \right] + \text{Phy}_{\text{C}} \cdot \frac{\mathrm{d}\,Q}{\mathrm{d}\,t}
 \tag{\ref{eq:sPhyN}.3}
\end{equation}
and plugging Eqs.~\eqref{eq:growth} and \eqref{eq:mortN} into Eq.~\eqref{eq:sPhyN3} yields:
\begin{equation}
  \label{eq:sPhyN4}
  \frac{\mathrm{d}\,\text{Phy}_{\text{N}}}{\mathrm{d}\,t} = \left[ \mu \cdot \text{Phy}_{\text{C}} \cdot Q - F_{\text{Phy}_{\text{N}}-\text{Det}_{\text{N}}} - D \cdot \text{Phy}_{\text{C}} \cdot Q \right] + \text{Phy}_{\text{C}} \cdot \frac{\mathrm{d}\,Q}{\mathrm{d}\,t}
 \tag{\ref{eq:sPhyN}.4}
\end{equation}
In Eq.~\eqref{eq:sPhyN4}, $\mu \cdot \text{Phy}_{\text{C}} \cdot Q$ can be identified with $F_{\text{DIN}-\text{Phy}_{\text{N}}}$ in the IA variant because $V_{\text{N}} = \mu\cdot Q$ for balanced growth. Following \citet{Smith2016}, we assign that the last term to $F_{\text{DIN}-\text{Phy}_{\text{N}}}$ too, yielding a re-definition of $F_{\text{DIN}-\text{Phy}_{\text{N}}}$ for the IA variant:
\begin{equation}
  \label{eq:Fdinphyn2}
  F_{\text{DIN}-\text{Phy}_{\text{N}}} = \text{Phy}_{\text{C}} \left[ \mu Q + \frac{\mathrm{d}\,Q}{\mathrm{d}\,t} \right] \hfill \{\text{IA}\}
  \tag{\ref{eq:Fdinphyn}.2}
\end{equation}
which essentially redirects part of the fluxes associated with $\text{Phy}_{\text{N}}$ to DIN\@.
Plugging this into Eq.~\eqref{eq:sdin}, and recognizing that $\frac{\mathrm{d}\,Q}{\mathrm{d}\,t} $ consists of partial derivatives with respect to $\text{DIN}$, daily average irradiance, $\bar{I}$, fractional daylength, $L_{\text{D}})$ and temperature, $T$ (see Appendix~\ref{S:Sol}):
\begin{flalign}\label{eq:sdin2}
\begin{split}
\frac{\text{d}\,\text{DIN}}{\text{d}\, t} &= F_{\text{DON}-\text{DIN}} - \text{Phy}_{\text{C}} \left[ \mu Q + \frac{\mathrm{d}\,Q}{\mathrm{d}\,t} \right] - D \cdot (\text{DIN}-\text{DIN}_{\text{in}}) \\
&= F_{\text{DON}-\text{DIN}} - \text{Phy}_{\text{C}} \left[ \mu Q 
    + \frac{\partial Q}{\partial \text{DIN}} \frac{\text{d}\, \text{DIN}}{\text{d}\, t}
    + \frac{\partial Q}{\partial \bar{I}} \frac{\text{d}\, \bar{I}}{\text{d}\, t}
    + \frac{\partial Q}{\partial L_{\text{D}}} \frac{\text{d}\, L_{\text{D}}}{\text{d}\, t}
    + \frac{\partial Q}{\partial T} \frac{\text{d}\, T}{\text{d}\, t} \right] 
    - D \cdot (\text{DIN}-\text{DIN}_{\text{in}})
\end{split} &  \{\text{IA}\}
\tag{\ref{eq:sdin}.2}\\
\intertext{and reorganizing the $\frac{\text{d}\, \text{DIN}}{\text{d}\, t}$ on the right hand side:}
\label{eq:sdin3}
\frac{\text{d}\,\text{DIN}}{\text{d}\,t} &= \frac{\displaystyle F_{\text{DON}-\text{DIN}} - \text{Phy}_{\text{C}} \left[\mu Q  
    + \frac{\partial Q}{\partial \bar{I}} \frac{\text{d}\, \bar{I}}{\text{d}\, t}
    + \frac{\partial Q}{\partial L_{\text{D}}} \frac{\text{d}\, L_{\text{D}}}{\text{d}\, t}
    + \frac{\partial Q}{\partial T} \frac{\text{d}\, T}{\text{d}\, t} \right] 
    - D \cdot (\text{DIN}-\text{DIN}_{\text{in}})}%
{\displaystyle 1+ \text{Phy}_{\text{C}}\frac{\partial Q}{\partial \text{DIN}}} & \{\text{IA}\} \tag{\ref{eq:sdin}.3}
\end{flalign}
The partial derivatives of $Q$ with respect to DIN, $\bar{I}$, $L_{\text{D}}$ and $T$ are obtained by canonical application of the chain rule, as detailed in Appendix~\ref{S:Sol}. The final terms required in Eq.~\eqref{eq:sdin3} are the changes in $\bar{I}$, $L_{\text{D}}$ and $T$ over time, i.e., $\text{d}\,\bar{I} / \text{d}\,t$, $\text{d}\,L_{\text{D}} / \text{d}\,t$ and $\text{d}\,T / \text{d}\,t$. When the irradiance and temperature are supplied externally, as is typically the case in coupled physical-biological models, it is not possible to obtain their temporal derivatives analytically.  Hence they are numerically approximated as the discrete backward difference between their current ($t=i$) and previous ($t=i-1$) values, divided by the integration time step, i.e., $\text{d}\, E / \text{d}\, t \approx (E_{i} - E_{i-1}) / \Delta t$ for $E=\{\bar{I},\ L_{\text{D}},\ T\}$ (see also Section~\ref{S:DescT1}).
Finally, for the case of multiple phytoplankton functional types (PFTs) indexed by $j$, Eq.~\eqref{eq:sdin3} can be generalized as follows:
\begin{flalign}\label{eq:sdin4}
\frac{\text{d}\,\text{DIN}}{\text{d}\,t} &= \frac{\displaystyle F_{\text{DON}-\text{DIN}} -
  \sum_j \text{Phy}_{\text{C}}^j \left[ \mu^j Q^j
    + \frac{\partial Q^j}{\partial \bar{I}} \frac{\text{d}\, \bar{I}}{\text{d}\, t}
    + \frac{\partial Q^j}{\partial L_{\text{D}}} \frac{\text{d}\, L_{\text{D}}}{\text{d}\, t}
    + \frac{\partial Q^j}{\partial T} \frac{\text{d}\, T}{\text{d}\, t} \right] 
    - D \cdot (\text{DIN}-\text{DIN}_{\text{in}})} %
{\displaystyle 1+ \sum_j \left[ \text{Phy}_{\text{C}}^j\frac{\partial Q^j}{\partial \text{DIN}} \right]} & \{\text{IA}\} \tag{\ref{eq:sdin}.4}
\end{flalign}

As a technical remark regarding the FABM implementation of the model: Eqs.~\eqref{eq:sdin3}--\eqref{eq:sdin4} require the combination of terms which are calculated by separate abiotic and phytoplankton modules in K21.  Therefore, in order to avoid a circular-dependency error in the current implementation, an intermediate module collects the necessary terms from the two modules, and sets the right-hand sides for DIN at once.

% Table
\begin{table*}[htb]
  \caption{ Descriptions, values and units of model parameters regarding phytoplankton growth. Parameters with prime ($C'$) are for a cell with an equivalent spherical diameter (ESD) of 1\unit{{\mu}m}, which is the size assumed for experiments T1 and T2. For T3, where different size classes are simulated, the respective values are obtained according to $C=C'\cdot \text{ESD}^{S_C}$, where $S_C$ is the allometric scaling coefficient for this parameter. Values for $C'$ and $S_C$ are as in \citet{Smith2016}, and other parameters as in \citet{Kerimoglu2021}.\label{T.pars}}
  \begin{tabular}{l l c l}
    \tophline
    Term/Symbol         & Definition                        & Value     & Unit\\
    \middlehline
    $\hat{\mu}_0$   & Potential maximum growth rate         & 5.0       & \unit{d^{-1}}\\
    $Q_0'$  & Subsistence quota                     & 0.039     & \unit{mmolN\ molC^{-1}}\\
    $S_{Q_0}$  & Allometric scaling coefficient of $Q_0$       & -0.18     & \unit{-}\\
    $\hat{A}_0'$     & Potential maximum nutrient affinity   & 0.15       & \unit{m^3\ mmolC^{-1}\ d^{-1}}\\
    $S_{A_0}$  & Allometric scaling coefficient of $\hat{A}_0$        & -0.8     & \unit{-}\\
    $\hat{V}_0'$     & Potential maximum N uptake rate       & 5.0       & \unit{molN\ molC^{-1}\ d^{-1}}\\
    $S_{V_0}$  & Allometric scaling coefficient of $\hat{V}_0$        & 0.2     & \unit{-}\\
    $\alpha$           & Chl-specific slope of P-I curve    & 1.0       & \unit{m^2\ E^{-1}\ molC\ gChl^{-1}}\\
    $R^{\text{Chl}}_{\text{M}}$     & Cost of Chl maintenance   & 0.1       & \unit{d^{-1}}\\
    $\zeta_{\text{Chl}}$   & Cost of Chl synthesis  & 0.5       & \unit{mmolC\ gChl^{-1}}\\
    $\zeta_{\text{N}}$     & Cost of N uptake               & 0.6       & \unit{molC\ molN^{-1}}\\
    $m$                & Mortality rate coefficient        & 0.01   & \unit{m^{3}\ mmolC^{-1}\ d^{-1}} \\
    $r_{\text{hyd}}$   & Hydrolysis rate constant          & 0.1   & \unit{d^{-1}} \\
    $r_{\text{rem}}$   & Remineralization rate constant    & 0.1   & \unit{d^{-1}} \\
    $D$   & Dilution rate    & 0 (T1-T3), 0.1 (T4)   & \unit{d^{-1}} \\
    DIC$_{\text{in}}$   & DIC concentration in the inflow medium  & 1000   & \unit{molC\ m^{-3}} \\
    DIN$_{\text{in}}$   & DIN concentration in the inflow medium  & 25   & \unit{molN\ m^{-3}} \\
    $w_{Det}$   & Sinking rate of detritus    & 0 (T1-T3); 0.2 (T4)   & \unit{m\  d^{-1}} \\
    $H_{\text{SML}}$   & Height of the SML    & 20   & \unit{m} \\
    \bottomhline
  \end{tabular}
  \belowtable{} % Table Footnotes
\end{table*}

\subsection{Test setups and model operation}\label{S:DescSetup}
    %\subsubsection{0D setup (T1-T3)}
    For all tests, the model is operated in a spatially homogeneous 1-box setup, using the 0D driver of FABM \citep{Bruggeman2014}. With this 0D setup, numerical solutions are obtained using a 4\textsuperscript{th} order Runge-Kutta method with a time step of 60 seconds. Model forcing applied in our 0D setup varies among different tests, as explained below.

    \subsubsection{T1}\label{S:DescT1}
    This test is designed to assess the effect of inaccuracies incurred by the numerical approximation of the time-derivatives of external forcing variables.  We consider two cases with regard to irradiance: For PAR:N the time-derivative is approximated numerically and for PAR:A it is obtained analytically.  In both cases, irradiance ($\bar{I}$) is provided (as implemented in K21) as a sinusoidal function of day of year ($t$) to represent a seasonal cycle typical of a high latitude environment in the northern hemisphere:
    \begin{flalign}\label{eq.I}
    \bar{I}(t) &= \bar{I}_{\min} + (\bar{I}_{\max}-\bar{I}_{\min}) 0.5 \left[ 1 + \sin \left[ 2 \pi t' \right]  \right], \qquad t' = \frac{t}{365} - 0.25
    \end{flalign}
    where $\bar{I}_{\min}= 1.6\, \mathrm{mol\,m^{-2}d^{-1}}$  and $\bar{I}_{\max} = \mathrm{110 \, mol\, m^{-2} d^{-1}}$ define the minimum and maximum values throughout the year and $t'$ represents the relative day of the year delayed by a quarter cycle to obtain the peak value at the middle of the year (see Fig.~\ref{f.T1light} for the behavior of the function with these parameters).  For simplicity, we assume that temperature, T, is fixed at 10$\degree$C, fractional day length, $L_D$, is unity, and we ignore light attenuation.
    \begin{subequations}
      \begin{description}
      \item [PAR:N] in the first case, the time-derivative of $\bar{I}$ is calculated numerically as a finite-difference approximation:
        \begin{equation}\label{eq.dIdtn}
          \frac{\text{d}\,\bar{I}}{\text{d}\,t} \approx \frac{\bar{I}_{i} - \bar{I}_{i-1}}{\Delta t}
        \end{equation}
        where $i$ is the time-step index and $\Delta t$ the time step of the numerical integration.
      \item [PAR:A] in the second case, the temporal derivative of short wave radiation is calculated  analytically:
        \begin{equation}\label{eq.dIdt}
          \frac{\text{d}\,\bar{I}}{\text{d}\,t} = (\bar{I}_{\max}-\bar{I}_{\min}) \frac{\pi}{365} \cos \left[ 2 \pi t' \right]
        \end{equation}
      \end{description}
    \end{subequations}
    The temporal derivatives found by the numerical and analytical approaches are almost identical (Fig.~\ref{f.T1light}).
    \begin{figure}[ht!]
    \includegraphics[width=12cm,trim=0mm 54mm 0cm 0mm, clip]{figures/2022-03-22a_Ld1_T20_ThatVar_PARint_vs_PARext/0D-Highlat_wconst_lext_Ld1_T20_CbasedIA_modular_24h_vs_0D-Highlat_wconst_lint_Ld1_T20_CbasedIA_modular_24h_cont_abio0_1y.png}
    \caption{Daily average irradiance and its temporal derivative, as extracted from the simulation outputs generated for T1. PAR:N (solid blue line) is the model version where the temporal derivative of irradiance is approximated numerically; PAR:A (dashed orange line): both irradiance and its temporal derivative are calculated analytically.\label{f.T1light}}
    \end{figure}

    \subsubsection{T2 -- T3}

    For these tests, we apply the numerical and analytical time-derivatives for $\bar{I}$ (Eqs.~\ref{eq.dIdtn} and~\ref{eq.dIdt}) and also for variable day length, $L_{\text{D}}$, and temperature, T\@. $L_{\text{D}}$, as described by \citet{Forsythe2003}, is used to calculate the instantaneous irradiance, based on the same irradiance function as in T1 (Eq.~\ref{eq.I}).  The seasonal variability in T is represented by a sinusoidal function analogous to Eq.~\eqref{eq.I}, with $T_{\min}=2\degree$C and $T_{\max}=20\degree$C.

    For T3, we compare simulations for 10 phytoplankton groups with the IA and DA variants. Phytoplankton groups represent different size classes across the range of 0.2--100 \unit{{\mu}m} equivalent spherical diameter (ESD), uniformly spaced on a logarithmic scale. As in \citet{Smith2016}, $Q_0$, $\hat{V}_0$ and $\hat{A}_0$ vary according to allometric relationships (Table~\ref{T.pars}). Scalings of $Q_0$ and $\hat{V}_0$ are based on a combination of cell-specific scalings of subsistence quotas \citep[][`marine species']{Edwards2012}, maximum uptake rates \citep{Maranon2013}, and cell-specific C content \citep[][`protist plankton excluding diatoms']{Menden2000}. Scaling of $\hat{A}_0$ is based on heuristics \citep{Smith2014a}.

As a technical note regarding the implementation, using the \verb|phy_Cbased.F90| and \verb|abio_Cbased.F90| modules, the number of phytoplankton types can be modified without changing or recompiling the code, by adjusting the configuration file (see the \verb|fabm.yaml| examples in the \verb|testcases| folder that were employed to produce the results presented in this study), which is a feature of the modularity of FABM\@.

    %\markus{I have recently analysed compilations of N subsistence quotas from the literature (though not including \citet{Edwards2012}) and found that many of those were not really subsistence quotas.  When I exclude those not being subsistence quotas and whose ESD > 100\unit{{\mu}m}, there is no size dependence.}\onur{This is interesting, but I think it is outside of the scope of the current ms. Let's keep the allometries as in Smith et al 2016.}

    \subsubsection{T4}

    In a closed system, where all mass is conserved, DIN can be calculated directly as the difference between the initial total mass and the sum of all other pools (e.g., $\text{DIN} = \text{Total N} - \text{DON} - \text{Det}_{\text{N}} - Q \cdot \text{Phy}_{\text{C}}$). This would eliminate the neccessity of deriving the additional differentials in Eq.~\eqref{eq:sdin3} (solutions of which are provided in Appendix~\ref{S:Sol}), and the resulting code could be significantly faster, owing to one less state variable (i.e., DIN) and lower amounts of logic and calculations. However, this would work only for closed systems.

    The aim of T4 is to evaluate the behavior of the model in open systems, such as chemostats, using a non-zero $D$ in Eqs.~\eqref{eq:sPhyC}--\eqref{eq:dic} to represent dilution, or the dynamics within a surface mixed layer (SML), using $D>0$ and $w_{\text{Det}}>0$, to represent mixing with the layer below the SML and sedimentation of detritus out of the SML, respectively. %\onur{do we need to tell about the motivation to include such a test (i.e., that in a closed system, DIN does not need to be dynamically traced, but can be found simply by substracting Q*PhyC, DON and DetN from the initial $\sum{N}$)? In my opinion we better tell this in the discussion.}
    In order to characterize an aquatic environment in a temperate climate zone that undergoes thermal stratification in summer, we consider a cyclic seasonal pattern in $D$, with values approaching to $D_{\max}=1.0$ during winter and $D_{\min}=0.001$ during summer:
    \begin{flalign}
      D = D_{\min}+ 0.25 (D_{\max} - D_{\min}) {\left[ 1 - \sin(2 \pi t')\right]}^2, \qquad t'=\frac{t}{365} - 0.15
    \end{flalign}

    \noindent where $t'$ is the relative day of the year, adjusted to mimic initiation of stratification by the beginning of April.

    In order to examine the mass balance of the model in such a setup, we introduce two new state variables, $\text{Ext}_{\text{C}}$ and $\text{Ext}_{\text{N}}$, which trace the amounts of N and C exported from and imported into the  system:
    \begin{flalign}
    \label{eq:Xext}
    \frac{\mathrm{d}\,\text{Ext}_{X}}{\mathrm{d}\,t} &= D \cdot \left(\text{Phy}_{X} + \text{Det}_{X}  + \text{DO}X + (\text{DI}X-\text{DI}X_{\text{in}}) \right) + \frac{w_{\text{Det}}}{H_{\text{SML}}} \cdot \text{Det}_{X}\ \text{,}\quad X \in \{\text{C, N}\}
    \end{flalign}
    such that the global amounts of N and C, i.e., the sums of these variables and the corresponding C and N variables in Eqs.~\eqref{eq:sPhyC}--\eqref{eq:dim}, should be conserved.  See Table~\ref{T.pars} for the values of the additional parameters that describe the dilution and sinking fluxes.

    For this test, we consider two PFTs with ESD's of 1 and 10 $\mu$m, with $Q_0$, $\hat{V}_0$ and $\hat{A}_0$ scaled as explained for T3 above. The configuration files for this test are provided with the code (see the code availability section).

%\subsubsection{1D setup (T4)}
%    \onur{I'm not sure if we really need to show these results, although I included them for now }

%\begin{figure}[t]
%\includegraphics[width=8.3cm,trim=0cm 6mm 0.0cm 10mm, clip]{figures/fI_analytical.png}
%\caption{Seasonal course of analytically described (Eqs.\eqref{f.Ian}) daily average irradiance (a) and its temporal derivative (b), with $\bar{I}_{\min}$=1.6 and $\bar{I}_{\max}$=110 [mol m$^2$ d$^{-1}$]. \label{f.Ian}}
%\end{figure}

%and $\frac{\text{d} \text{DIN}}{\text{d} t} \approx \frac{\text{DIN}_{i} - \text{DIN}_{i-1}}{\Delta t}$.

%\newpage

% RESULTS
\section{Results}

\subsection{Accuracy of numerical approximation of the temporal derivative of light (T1)}
The model is conservative with respect to C and mostly also N (Fig.~\ref{f.T1res}), for both numerically-approximated (PAR:N) and analytically-calculated (PAR:A) temporal derivatives of irradiance (see the details in Section.~\ref{S:DescT1}). The range of deviation (difference between maximum and minimum values obtained throughout the run) of total N is about twofold higher in the PAR:N run than in the PAR:A run (see Fig.~\ref{f.T1res}), and corresponds to about 0.0003\% of the total N in the system. This suggests that the numerical approximation of the derivative of light does introduce some additional error.
%For PAR:N, total N slightly (about 0.02 \unit{mmolN\ m^{-3}}) increases at the very beginning of the simulation, which is caused by the unknown previous value of $\bar{I}$ during the first day of the simulation (as required by the numerical approximation of $\text{d}\,\bar{I}/\text{d}\,t$), which is set to the current value ($\bar{I}_{0} = \bar{I}_{1} \Rightarrow \text{d}\,\bar{I}/\text{d}\,t = 0$), causing therefore a difference between the total N as simulated by the analytical approach (PAR:A). However, after this initial jump, this new baseline is preserved until the end of the simulation. \markus{This is not shown in Fig.~\ref{f.T1res}: the blue curve starts out almost the same as the yellow curve and loses some N until the end of the simulation.  Maybe you confused this with Fig.~\ref{f.T2res}, top-right panel?}\onur{I guess this is from an old version of the model, and meanwhile this issue is fixed somehow apparently, although I'm not sure how and when really.}

\begin{figure}[ht!]
\includegraphics[width=12cm,trim=0cm 16.8cm 0.0cm 5mm, clip]{figures/2022-03-22a_Ld1_T20_ThatVar_PARint_vs_PARext/0D-Highlat_wconst_lext_Ld1_T20_CbasedIA_modular_24h_vs_0D-Highlat_wconst_lint_Ld1_T20_CbasedIA_modular_24h_cont_abio1_1y.png}
\caption{T1: Carbon (left) and nitrogen (right) pools for the PAR:N (solid blue line), and PAR:A (dashed orange line) simulations.
%\onur{I think the other panels (din,phy,det,don) are not necessary to include here}
\label{f.T1res}}
\end{figure}

\FloatBarrier%

\subsection{Testing the IA approach in a more realistic setup, in comparison to the fully explicit DA approach (T2)}

For T2 we consider seasonal variations also in $T$ and $L_{\text{D}}$ (Fig.~\ref{f.T2env}).  Note that variations in $L_{\text{D}}$ also affect the seasonal cycles of $\bar{I}$ and $\text{d}\bar{I}/\text{d}t$.

\begin{figure}[ht!]
  \includegraphics[width=12cm,trim=0mm 0mm 0cm 0mm, clip]{figures/2022-05-06a_Ldvar_Tvar_ThatVar_PARext_IA_vs_DA/0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_CbasedIA_modular_24h_vs_0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_CbasedDA_modular_24h_cont_abio0_2y.png}
  \caption{Daily average irradiance and temperature and their numerically approximated temporal derivatives used in T2.\label{f.T2env}}
\end{figure}


% \begin{figure}[ht!]
% \centering
%   \setlength{\unitlength}{1mm}
%   \begin{picture}(120,70)(0,0)
%     \put(0,45){
%     \begin{overpic}[width=14cm,trim=0cm 16.8cm 0.0cm 5mm, clip]{figures/2022-02-10b_Ld1_T20_ThatVar_PARext_IA_vs_DA/0D-Highlat_wconst_lext_Ld1_T20_CbasedIA_modular_24h_vs_0D-Highlat_wconst_lext_Ld1_T20_CbasedDA_modular_24h_cont_abio1_1y.png}
%     \end{overpic}}
%     \put(0,22){
%     \begin{overpic}[width=14cm,trim=0cm 16.8cm 0.0cm 14mm, clip]{figures/2022-02-10c_Ldvar_T20_ThatVar_PARext_IA_vs_DA/0D-Highlat_wconst_lext_Ldvar_T20_CbasedIA_modular_24h_vs_0D-Highlat_wconst_lext_Ldvar_T20_CbasedDA_modular_24h_cont_abio1_1y.png}
%     \end{overpic}}
%     \put(0,0){
%     \begin{overpic}[width=14cm,trim=0cm 16.8cm 0.0cm 14mm, clip]{figures/2022-03-22d_Ldvar_Tvar_ThatVar_PARext_IA_vs_DA/0D-Highlat_wconst_lext_Ldvar_Tvar_CbasedIA_modular_24h_vs_0D-Highlat_wconst_lext_Ldvar_Tvar_CbasedDA_modular_24h_cont_abio1_1y.png}
%     \end{overpic}}
%     %\put(9,26){\scriptsize{\textsf{(a)}}}
%     %\put(69,26){\scriptsize{\textsf{(b)}}}
%   \put(0,0){\tiny \grid(140,70)(5,5)[0,0]}
%   \end{picture}
%
% \caption{Results of T2: Carbon (left) and nitrogen (right) pools according to the IA (solid blue line) and DA (dashed orange line) approaches, (a-b) under constant $L_{\text{D}}=1$ and $T=20^{\circ}C$;  (c-d) variable $L_{\text{D}}$; (e-f) constant $T=20^{\circ}C$;  variable $L_{\text{D}}$ and$T$; . \onur{Again, I think no other panels required here}.\label{f.T2ares}}
% \end{figure}

%\subsection{Comparison of IA approach to the fully explicit DA approach (T2b)}

The IA and DA variants produce almost identical results (Figs.~\ref{f.T2res},~\ref{f.T2resdif}). This similarity is expected \citep{Ward2017}. On a closer look, some differences can be detected, such as slightly higher $\text{Phy}_{\text{N}}$ at the peak of the spring bloom and slightly higher $\text{Det}_{\text{N}}$ shortly after the spring bloom in the DA variant.  The differences are due to the re-allocation of part of the fluxes between $\text{Phy}_{\text{N}}$ and DIN according to Eq.~\eqref{eq:sdin3}.  They remain relatively small because (1) the time scale of the optimal regulation of N uptake in the DA variant is short relative to those of phytoplankton growth and the DIN-changes in our simulations, and (2) the strong interaction between phytoplankton and DIN leads to a negative feed-back between the deviations between the IA and DA variants and the extra DIN fluxes caused by variations in $Q$ in the IA variant.

\begin{figure}[htb!]
\includegraphics[width=14cm,trim=0cm 11mm 0.0cm 5mm, clip]{figures/2022-05-06a_Ldvar_Tvar_ThatVar_PARext_IA_vs_DA/0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_CbasedIA_modular_24h_vs_0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_CbasedDA_modular_24h_cont_abio1_2y.png}
\caption{T2: Carbon (left) and nitrogen (right) pools for the IA (solid blue line) and DA (dashed orange line) variants with variable daylength and temperature.
%\onur{We had planned to show box-whisker plots instead of this, but looking at that plot, I feel like we may want to keep this} \markus{I don't get the large discrepancy in the top-right panel in my calculations, maybe check the initial conditions?  I would suggest to include the first row in Fig.~\ref{f.T2env}.  Then (without DOM) we could show 6 rows (PhyC etc.) and two columns (DA and (IA - DA)/DA).  This would show clearly the extent of the differences along with the actual model behaviour, so we don't need the box-and-whisker plots.}\onur{thanks for the suggestions. Indeed, the differences between totN and totC were due to initial conditions for PhyN in the DA variant: adopting the diagnostic PhyN estimated by the IA at the first time time step as the IC for DA variant fixed the problem. I now removed the figure with box-whisker plots, and the new Fig.~\ref{f.T2resdif} shows directly the diffrences between the IA and DA variatns. As the DIN approaches 0 during summer, the relative differences become too huge (>500), so I think it's better to show the absolute differences. But note your layout suggestion doesn't work, we have too many panels, so I think this has to be a seperate figure, but maybe we can put it in an appendix.}
\label{f.T2res}}
\end{figure}

\begin{figure}[htb!]
\includegraphics[width=14cm,trim=0cm 11mm 0.0cm 5mm, clip]{figures/2022-05-06a_Ldvar_Tvar_ThatVar_PARext_IA_vs_DA/IA-DIF-DA_cont_abio1_1y.png}
\caption{T2: Differences between the IA and DA variants for the quantities shown in Fig.~\ref{f.T2res}.\label{f.T2resdif}}
\end{figure}

% \begin{figure}[htb!]
% \includegraphics[width=14cm,trim=0cm 0mm 0.0cm 0mm, clip]{figures/2022-03-22d_Ldvar_Tvar_ThatVar_PARext_IA_vs_DA/0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_Cbased_modular_24h_IAvsDA_boxplot_CN.png}
% \caption{Results of T2: Carbon (left) and nitrogen (right) pools according to the IA (solid blue line) and DA (dashed orange line) approaches under variable $L_{\text{D}}$ and $T$. \onur{I'm not sure whether this is really better than Fig.~\ref{f.T2res}. Maybe we keep them both?} \markus{No, I would modify Fig.~\ref{f.T2res} and leave this one out (I don't really see anything here).}.\label{f.T2resbox}}
% \end{figure}


\FloatBarrier%
\subsection{T3: Comparing DA and IA variants in simulating in simulating multiple PFTs}\label{s.resT3}

Fig.~\ref{f.T3res} shows results of experiment T3 with 10 phytoplankton size classes for our IA and DA variants. Annually-averaged concentrations decrease with cell size, and the larger classes exhibit stronger seasonal relative variations. Under other environmental conditions, e.g., different initial conditions or temporal variability, different outcomes can emerge \citep[see, e.g.,][]{Taherzadeh2017}, but this is outside of the scope of our current study.  C biomass of phytoplankton by the two variants is near-identical.  However, differences do exist during the spring bloom, with concentrations of smaller groups being higher in the IA than in the DA variant, and vice versa for the larger groups. Concentrations of the larger groups are higher in the DA variant, likely because the extra DIN derived in the IA variant from the increasing cell quotas during the spring bloom benefits the larger cells less than the smaller cells as imposed by the allometric relationships \citep[as in][]{Grover1991a,Litchman2009}. \onur{and I guess the reason for the concentration of smaller groups being higher in the IA variant is the faster optimization of Q, and therefore fV, but I'm not sure. Any other ideas?} \markus{I think the affinity-scaling dominates this part.  Also, above we cite \citet{Edwards2012}, \citet{Smith2014a}, etc.\ for the scaling, which way is correct?} \onur{i realized now that the small cells are growing faster in the IA variant exactly because the large cells grow less, which therefore does not need an additional explanation. Edwards 2012 is for the scaling the Q0, Smith etal 2014a is for the scaling of A0}

\begin{figure}[ht!]
\includegraphics[width=16cm,trim=0cm 0mm 0.0cm 0mm, clip]{figures/2022-05-07_Ldvar_Tvar_ThatVar_10P_PARext_IA_vs_DA/0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_10P_Cbased_IAvsDAvsDIF_lineplot_size.png}
\caption{T3: C biomass of 10 phytoplankton size classes in the IA (solid line) and DA (dotted line) variants (left) and the difference between IA and DA (right).
  % \markus{Here I would suggest two panels.  One for the DA results with $\log(\text{ESD})$ on the y-axis, divided into similarly-spaced sections, time on the x-axis and concentration shown as colour.  The other panel would have the same layout but with the colour showing (again) (IA -- DA)/DA.}\onur{I tried this but did not like the result that much. I think with these line plots one can more easily see what's going on. But again, I prefer the absolute difference instead of the relative difference.}
}\label{f.T3res}
\end{figure}

%In Fig.~\ref{f.T3res} we present the results of a numerical experiment with 2 phytoplankton functional types, as simulated by IA and DA.The first type characterizes a fast growing `opportunist' species, and the second type characterizes a `gleaner' species, with lower growth rate but higher nutrient affinity. As expected, the first type reaches higher C-biomass during the spring bloom, whereas the second type maintains higher concentrations during summer, under low nutrient concentrations. The predictions by the two variants are almost identical.
% \begin{figure}[ht!]
% \includegraphics[width=14cm,trim=0cm 11mm 0.0cm 5mm, clip]{figures/2022-03-22e_Ldvar_Tvar_ThatVar_2P_PARext_IA_vs_DA/0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_2P_CbasedIA_modular_24h_vs_0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_2P_CbasedDA_modular_24h_cont_abio1_2y.png}
% \caption{Results of T3: Carbon (left) and nitrogen (right) pools according to the IA (solid blue line) and DA (dashed orange line) approaches under variable $L_{\text{D}}$ and $T$ and 2 phytoplankton types. \onur{Figure is for drafting purposes}.\label{f.T3res}}
% \end{figure}

\FloatBarrier%
\subsection{T4: Comparing DA and IA variants in a non-closed system}\label{s.resT4}

In T4, we consider competition between two species in an open system forced by fluxes to and from an external environment.  We simulate a surface-mixed-layer (SML), where mixing with the deeper layer can introduce new nutrients (DIN and DIC) and dilute all other variables \markus{(also DON?)}\onur{yes, although this may not be entirely realistic. But I guess this does not matter from a conceptual perspective}, and sedimentation exports detrital C and N out of the system. As typically observed in aquatic environments located in temperate climate zones, we prescribe a seasonally-varying mixing coefficient, with lower values during summer due to thermal stratification.

Under such a regime, the system captures the characteristic features of a temperate aquatic environment, with low phytoplankton biomass during winter, a strong spring bloom, depletion of DIN within the SML during summer, and an autumn bloom. Accordingly, the total N in the system shows a strong seasonal pattern (Fig.~\ref{f.T4res}). However, when the external N is taken into account, the global amount of N is conserved by the model, demonstrating that the model behavior is consistent with the mass-balance requirement of such an open system.

\begin{figure}[ht!]
\includegraphics[width=12cm,trim=0cm 18mm 0.0cm 15mm, clip]{figures/2022-05-06c_Ldvar_Tvar_ThatVar_PARext_Dvar_sdet01_IA_vs_DA/0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_2P_Dmax1_sdet01_CbasedIA_modular_24h_vs_0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_2P_Dmax1_sdet01_CbasedDA_modular_24h_cont_abio1_2y.png}
\caption{T4: Annual variations of global C and N (sum of total C/N and Ext$_{\text{C/N}}$, see Eq.~\eqref{eq:Xext}), total C/N (sum of $\sum\text{Phy}^j$, DIM, DOM, Det) and other state variables that trace N in individual pools for a seasonally varying mixing regime and sedimentation fluxes. \markus{I would suggest to remove the panels for global and total C, since the mass-balance for C is trivial also for the IA variant.  This would make the caption much easier to read. \onur{I feel like showing the global C/N is needed as a proof of concept and implementation. I agree however that the caption is not easy. I tried improving it now, but it's still not too easy I guess. I suggest to see what the reviewers think about this.}}}\label{f.T4res}
\end{figure}


%\include{res1D}

\FloatBarrier%
% DISCUSSION
\section{Discussion}

In this study, we present FABM-NflexPD 2.0, a FABM implementation of the FlexPFT model introduced by \citet{Smith2016} with a few minor corrections (see the notes at the end of Appendix~\ref{S:Sol}). The precursor, FABM-NflexPD 1.0 \citep{Kerimoglu2021}, resolves only the N cycle, and the C-cycle is not closed.  FABM-NflexPD 2.0 can resolve both N- and C-cycles in a 0D setup, owing to an additional flux term to maintain the mass balance of N (Sections~\ref{S:DescFlux} and Appendix~\ref{S:Sol}).

\subsection{Re-establishing the Mass Balance}

Two variants of the model are elaborated here. The `Dynamic Acclimation' (DA) variant is fully explicit in its treatment of the C and N content of phytoplankton, as in the model by \citet{Fernandez-Castro2016}. 
%\markus{(We only show steady-state solutions in \citet{Pahlowetal13}, so this is a better reference here)}\onur{ok, thanks.} 
The `Instantaneous Acclimation' (IA) variant aims to track the phytoplankton dynamics with a single state variable, based on a balanced growth approximation \citep{Burmaster1979}, that is, assuming that cells reach the equilibrium state instantaneously.

Owing to the lack of a state variable $\text{Phy}_{\text{N}}$, Eqs.~\eqref{eq:sPhyC} --~\eqref{eq:dim} do not preserve mass (total N) because they ignore the contribution of the rate of change of $Q$ to the rate of change of $\text{Phy}_{\text{N}}$.  It is impossible to maintain mass balance mechanistically without adding a state variable $\text{Phy}_{\text{N}}$.  However, we can re-establish mass balance to a large extent, by assigning the missing N flux to the DIN compartment in Eq.~\eqref{eq:sdin3}.  While this may be a rather arbitrary measure for achieving N mass balance and also violates the assumptions behind the model by assigning part of $\text{Phy}_{\text{N}}$ to DIN, the resulting differences compared to explicitly resolving $\text{Phy}_{\text{N}}$ are relatively small, as was also shown previously \citep{Ward2017}.

Through detailed tests, we show that N is conserved 
%\markus{this is trivial for C because IA and DA are identical with respect to the C mass balance}\onur{ok, let's not mention C} 
to a very large degree (for all tests we conducted, max. error was $0.0063\%$, which was for T1). 
%\markus{but we quote 0.0003\% above for PAR:N}\onur{true, in fact for PAR:N, the error corresponds to 0.006%}
We also show that the predictions of the IA and DA variants are mostly indistinguishable. Finally, with a simulation of 10 phytoplankton size classes with our two model variants, we demonstrate that the model is well aligned with the modular coupling philosophy of FABM \citep{Bruggeman2014}.

As explained in Section~\ref{S:DescFlux}, reducing the errors in mass balance for N requires explicitly calculating the changes in N quota over time, i.e., $\textrm{d}Q/\textrm{d}t$, which in turn requires calculation of individual components of this change driven by different environmental factors, namely, DIN, $\bar{I}$, T and $\textrm{L}_{\textrm{D}}$.  Under the idealized setup of T2, changes in DIN are clearly the dominant source of variation in Q.  However, contributions by other factors are non-negligible (Fig.~\ref{f.T2dQdt}). In other setups, the relative importance of various environmental factors may be different. Relevance of these secondary factors to the elemental stoichiometry of phytoplankton is an often neglected aspect. We expect our mathematically explicit treatment of this issue to inspire and contribute to future endeavors to establish an analytical framework for investigating the mechanistic underpinnings of plankton physiology.

\begin{figure}[ht!]
\includegraphics[width=12cm,trim=0cm 0mm 0.0cm 0mm, clip]{figures/2022-05-06a_Ldvar_Tvar_ThatVar_PARext_IA_vs_DA/0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_CbasedIA_modular_24h_vs_0D-Highlat_wconst_lext_Ldvar_Tvar_DIN015_CbasedDA_modular_24h_cont_phy-4_2y.png}
\caption{For T2 experiment, total $\textrm{d}Q/\textrm{d}t$ and its components as contributed by the changes in DIN, $\bar{I}$, $\textrm{L}_{\textrm{D}}$ and T.\label{f.T2dQdt}}
\end{figure}

 Moreover, although the model, as of its current state, is not ready to be used in a spatial setup (see below), we believe that this study can provide the basis for extension of the model to a potential extension to a spatially explicit framework.

\FloatBarrier
\subsection{Computational Efficiency and Application Potential}

Our results demonstrate that a state variable that tracks the elemental content of plankton can be effectively removed, without leading to major issues in mass balance, in a 0D setup. In comparison to a fully explicit dynamic variant, removing a state variable does not seem to result in clear advantages in computational efficiency in such a spatially truncated setup that does not require calculation of spatial transport.
%, at least not for simulating a low number of phytoplankton groups.  However, when simulating 50 groups, IA is $10.2 \%$ faster (Fig.~\ref{f.speed}).
%For simulations with a small number of groups, 
Any potential reduction in computational costs owing to one less state variable in the IA variant is presumably compensated by the additional calculations required for the derivatives in Eq.~\eqref{eq:sdin3} (see Appendix-\ref{S:Sol}).
%However, for a larger number of groups, requirements for allocating memory to trace a greater number of state variables probably outweighs the additional costs associated with the flux calculations. % \onur{these were some quick thoughts, if anyone knows something more about this, or a reference, please let me know}.

%\begin{figure}[ht!]
%\includegraphics[width=8cm,trim=15mm 20mm 25mm 27mm, clip]{figures/time_of_run_barplot.png}
%\caption{Simulation times for different numbers of phytoplankton groups.\label{f.speed}}
%\end{figure}

The modelling framework FABM, in which the model is implemented, allows seamless coupling of models with various hydrodynamical hosts \citep{Bruggeman2014}. We have also attempted an application in a 1D setup using GOTM \citep{Burchard2006} as the hydrodynamical host, and found out that N is not conserved. This is to be expected, because the spatial transport calculations do not account for spatial gradients in $Q$, which introduces errors analogous to the difference between Eqs.~\eqref{eq:sdin} and~\eqref{eq:sdin3}.  It may be possible to develop a mass conservative IA approach for spatially explicit models, by accounting for spatial variations of Q, in addition to its temporal variations. For FABM implementation, this would require additional spatial flux terms to be communicated with the hydrodynamical driver. It is not clear whether the resulting model would be faster than the fully explicit variant: On one hand, in a spatially explicit setup, reducing the number of state variables would also reduce the size of the necessary transport matrices.  On the other hand, fluxes associated with spatial changes in $Q$ would require additional logic and calculations. As mentioned above, 
%performance advantages of the instantaneous acclimation approach emerge only for a large number of phytoplankton groups in our 0D setup. 
we have not found evidence for performance advantages of the IA approach in a 0D setup. However, in spatially explicit setups, transport calculations can become computationally more demanding than calculating the right-hand sides of a biogeochemical model, therefore, reducing the number of state variables might offer computational advantages.
%even for simulating fewer phytoplankton groups.

%CONCLUSION
%\section{Conclusions}


\codeavailability{For running the model and reproducing the results presented in this study, FABM (submodule version that matches GOTM v6.0.0) needs to be installed with its 0d driver as the `host' (see \url{https://github.com/fabm-model/fabm/wiki/Building-and-installing}). The version of the FABM-NflexPD used in this manuscript has been stored in a Zenodo repository, accessible under: \url{https://doi.org/10.5281/zenodo.6600755}. Instructions for compiling FABM-NflexPD for GOTM-FABM and our 0D setup are provided in README.md. The \texttt{src} folder contains the Fortran code. The model was implemented as two separate modules: the \texttt{phy.F90} module that describes phytoplankton growth and the \texttt{abio.F90} module that describes everything other than phytoplankton (See Fig.~1 in \citet{Kerimoglu2021}). The phytoplankton module can reproduce the behavior of both the IA and DA variants considered in the manuscript by setting model parameters. The \texttt{testcases} folder contains the configuration (yaml) file that was used to produce the results for T4 in this manuscript, which can be simplified or extended to conduct the other tests.}


%\dataavailability{TEXT} %% use this section when having only data sets available


%\codedataavailability{TEXT} %% use this section when having data sets and software code available


%\sampleavailability{TEXT} %% use this section when having geoscientific samples available


%\videosupplement{TEXT} %% use this section when having video supplements available

%\clearpage
\appendix
\section{Analytical Solutions}\label{S:Sol}
To facilitate the solutions of the $\partial Q/\partial E$ ($E=\{\mathrm{DIN},\bar{I},\mathrm{T},\mathrm{L}_\mathrm{D}\}$) in Eq.~\eqref{eq:sdin3}, we introduce a new variable $Z$ and re-write Eq.~\eqref{eq:Qopt} in terms of $Z$ \citep[S16 in the following]{Smith2016}:
\begin{flalign}
  \label{eq.Z}
  Q &= \frac{Q_{0}}{2} \left( 1 + \sqrt{1 + \frac{1}{Z}}  \right), \qquad Z = \frac{Q_{0}}{2}\left( \frac{\hat{\mu}_{\text{net}}}{\hat{V}_{\text{N}}} + \zeta_{\text{N}} \right) \\
  \label{eq.delQdelN}
 \frac{\partial Q}{\partial \text{DIN}} &= \frac{\partial Q}{\partial Z} \frac{\partial Z}{\partial \text{DIN}}, \qquad
 \frac{\partial Q}{\partial \bar{I}}  = \frac{\partial Q}{\partial Z} \frac{\partial Z}{\partial \bar{I}}, \qquad
 \frac{\partial Q}{\partial L_{\text{D}}} = \frac{\partial Q}{\partial Z} \frac{\partial Z}{\partial L_{\text{D}}}, \qquad
 \frac{\partial Q}{\partial T} = \frac{\partial Q}{\partial Z} \frac{\partial Z}{\partial T}
\end{flalign}
In Eqs.~\eqref{eq.delQdelN}, the common term $\partial Q / \partial Z$, as in S16, is:
\begin{equation} \label{eq:delQdelZ}
 \frac{\partial Q}{\partial Z} = \frac{-Q_{0}}{4 \cdot Z \cdot \sqrt{Z\cdot(1+Z)}}
\end{equation}
Recalling $\hat{V}_{\text{N}}$ from K21, Eq.~(17):
\begin{flalign}
  \hat{V}_{\text{N}} &= \frac{(1-f_{\text{A}})\hat{V}_{0} f_{\text{A}} \hat{A}_{0} \text{DIN}}{(1-f_{\text{A}})\hat{V}_{0} + f_{\text{A}} \hat{A}_{0} \text{DIN}}
  = \frac{\hat{V}_{0}\cdot \hat{A}_{0}\cdot\text{DIN}}{{(\sqrt{\hat{V}_{0}} + \sqrt{\hat{A}_{0}\cdot \text{DIN}})}^{2}}, \qquad
  f_{\text{A}} = \frac{1}{\displaystyle 1 + \sqrt{\frac{\hat{A}_{0}\cdot\text{DIN}}{\hat{V}_{0}}}} \\
  \intertext{We set the potential maximum rates of N and C acquisition numerically equal to the maximum-rate parameter $\mu_{0}$ \citep{Pahlowetal13}:}
  \label{eq:v0mu0}
  \hat{V}_{0} &= \hat{\mu}_{0} = \mu_{0} \cdot f(T) \qquad f(T) = \exp\left[ -\frac{E_{\text{a}}}{R}\left( \frac{1}{T / \text{K}} - \frac{1}{T_{\text{ref}} / \text{K}} \right) \right]
\end{flalign}
the partial derivative of $Z$ with respect to DIN is:
\begin{flalign}
  \frac{\partial Z}{\partial \text{DIN}} = \frac{\partial Z}{\partial \hat{V}_{\text{N}}} \frac{\mathrm{d}\, \hat{V}_{\text{N}}}{\mathrm{d}\, \text{DIN}}
  = -\frac{\hat{\mu}_{\text{net}} \cdot Q_{0}}{2 \cdot\hat{A}_{0}\cdot \text{DIN}^{2}} \left( 1 + \sqrt{\frac{\hat{A}_{0}\cdot \text{DIN}}{\hat{V}_{0}}} \right)
\end{flalign}

For calculating the partial derivative of $Z$ with respect to $\bar{I}$, ${\partial Z}/{\partial \bar{I}}$, we recall $\hat{\mu}_{\text{net}}$, $L_{\text{I}}$ and $\hat{\theta}$ from K21, Eqs.~(20)--(23) \& (26):
\begin{flalign}
  \hat{\mu}_{\text{net}} &= L_{\text{D}}\hat{\mu}_{0} L_{\text{I}} (1-\zeta_{\text{Chl}}\hat{\theta})- R^{\text{Chl}}, \qquad
    R^{\text{Chl}} = f(T) \cdot R_{\text{M}}^{\text{Chl}} \zeta_{\text{Chl}}\hat{\theta} \\
  L_{\text{I}} &= 1 - \exp \left( \frac{-\alpha \hat{\theta} \bar{I}}{\hat{\mu}_{0}} \right), \qquad
  \hat{\theta} = \frac{1}{\zeta_{\text{Chl}}} + \frac{\hat{\mu}_{0}}{\alpha\cdot \bar{I}} \cdot (1 - W), \qquad
  W = \mathrm{W}_{0} \left[ \left( 1 + \frac{f(T) \cdot R_{\text{M}}^{{\text{Chl}}}}{L_{\text{D}} \cdot \hat{\mu}_{0}} \right)
   \cdot \exp \left( 1 + \frac{\alpha \cdot \bar{I}}{\hat{\mu}_{0} \cdot \zeta_{\text{Chl}}} \right) \right]
\end{flalign}
where $\mathrm{W}_{0}$ is the 0-branch of Lambert's W-function, and $\alpha$ and $\zeta_{\text{Chl}}$ are model parameters (initial Chl-specific slope of P-I curve and cost of Chl synthesis, respectively, Table~3 in K21). %  $\hat{\theta}$ is the optimal Chl density in the chloroplast.\\
$\partial Z/ \partial \bar{I}$ can then be derived by canonical application of the chain rule:
\begin{flalign}
 \frac{\partial Z}{\partial \bar{I}} &=
 \frac{\partial Z}{\partial \hat{\mu}_{\text{net}}} \left( \frac{\partial \hat{\mu}_{\text{net}}}{\partial\bar{I}}
   + \frac{\partial \hat{\mu}_{\text{net}}}{\partial\hat{\theta}} \frac{\mathrm{d}\, \hat{\theta}}{\mathrm{d}\,\bar{I}} \right)
 = \frac{\partial Z}{\partial \hat{\mu}_{\text{net}}} \frac{\partial \hat{\mu}_{\text{net}}}{\partial\bar{I}}
 \qquad  (\text{because}~ \frac{\partial{\hat{\mu}_{\text{net}}}}{\partial \hat{\theta}} = 0 ~ \text{by definition}) \\
 \frac{\partial Z}{\partial \hat{\mu}_{\text{net}}} &= \frac{Q_{0}}{2 \cdot \hat{V}_{\text{N}}} \\
 \frac{\partial \hat{\mu}_{\text{net}}}{\partial\bar{I}} &= L_{\text{D}} \cdot (1-\hat{\theta} \cdot \zeta_{\text{Chl}})  \cdot \alpha \cdot \hat{\theta} \cdot (1-L_{\text{I}}) \\
% \frac{\partial \hat{\mu}_{\text{net}}}{\partial\hat{\theta}} &= L_{\text{D}} \cdot [ \alpha \cdot \bar{I} \cdot ( 1 - L_{\text{I}} ) \cdot (1 - \zeta_{\text{Chl}} \cdot \hat{\theta}) - L_{\text{I}} \cdot \zeta_{\text{Chl}} \cdot \hat{\mu}_{0} ] - R_{\text{M}}^{\text{Chl}} \cdot \zeta_{\text{Chl}} \\
% \frac{\mathrm{d}\, \hat{\theta}}{\mathrm{d}\, \bar{I}} &= -\frac{\hat{\mu}_{0}}{\alpha\cdot \bar{I}^{2}} (1 - W) - \frac{W}{1 + W} \frac{1}{\bar{I}\cdot \zeta_{\text{Chl}}}
 \intertext{The day-length derivatives are}
 \frac{\partial Z}{\partial L_{\text{D}}} &= \frac{\partial Z}{\partial \hat{\mu}_{\text{net}}} \left( \frac{\partial \hat{\mu}_{\text{net}}}{\partial L_{\text{D}}}
   + \frac{\partial \hat{\mu}_{\text{net}}}{\partial\hat{\theta}} \frac{\mathrm{d}\, \hat{\theta}}{\mathrm{d}\,\bar{I}} \right)
 = \frac{\partial Z}{\partial \hat{\mu}_{\text{net}}} \frac{\partial \hat{\mu}_{\text{net}}}{\partial L_{\text{D}}} \\
 \frac{\partial \hat{\mu}_{\text{net}}}{\partial L_{\text{D}}} &= \hat{\mu}_{0} \cdot L_{\text{I}} \cdot (1 - \zeta_{\text{Chl}} \hat{\theta})
\end{flalign}
%The partial derivatives of $T$ Eq.~\eqref{eq:sdin3} are approximated numerically, as the analytical solution of $\partial Q/\partial T$ is unwieldy, given the temperature dependence of $\hat{\mu}_0$,  $\hat{V}_0$ and $R_{\text{M}}^{\text{Chl}}$, and numerous occurrence of these terms in intermediate quantities $\hat{\theta}$ and $L_{\text{I}}$ when $Q$ (Eq.~\ref{eq:Qopt}) is fully expanded. The numerical difference approximation is achieved by storing the value of $T$ in the previous integration step ($t=i-1$), calculating $Q$ based on this previous value of $T$ (but the values of DIN, $\bar{I}$ and $L_{\text{D}}$ in the current time step ($t=i$)), and subtracting this from the current value of $Q$, i.e.,
%\begin{align}
% \frac{\partial Q}{\partial T} & \approx
% \frac{Q(\text{DIN}_{i},\ \bar{I}_{i},\ L_{\text{D}_i},\ T_{i}) - Q(\text{DIN}_{i},\ \bar{I}_{i},\ L_{\text{D}_i},T_{i-1})} {T_{i} - T_{i-1}}
%\end{align}
The temperature-derivative of $Z$ is obtained via the derivatives with respect to $\hat{\mu}_{0}$, $\hat{V}_{0}$ and $R^{\text{Chl}}$:
\begin{flalign}
  \begin{split}
    \frac{\partial Z}{\partial T}
    &=   \frac{\partial Z}{\partial \hat{\mu}_{\text{net}}}
      \left( \frac{\partial \hat{\mu}_{\text{net}}}{\partial \hat{\mu}_{0}} \frac{\partial \hat{\mu}_{0}}{\partial T}
        + \frac{\partial \hat{\mu}_{\text{net}}}{\partial R^{\text{Chl}}} \frac{\partial R^{\text{Chl}}}{\partial T} \right)
      + \frac{\partial Z}{\partial \hat{V}_{\text{N}}} \frac{\partial \hat{V}_{\text{N}}}{\partial \hat{V}_{0}} \frac{\partial \hat{V}_{0}}{\partial T} \\ &
    = \left[ \frac{\partial Z}{\partial \hat{\mu}_{\text{net}}}
      \left( \frac{\partial \hat{\mu}_{\text{net}}}{\partial \hat{\mu}_{0}} \cdot \hat{\mu}_{0} - R^{\text{Chl}} \right)
      + \frac{\partial Z}{\partial \hat{V}_{0}} \cdot \hat{V}_{0}
    \right] \frac{1}{f(T)} \frac{\text{d}\,f(T)}{\text{d}\,T}
  \end{split}
  \\
  \frac{\partial \hat{\mu}_{net}}{\partial \hat{\mu}_{0}} &= L_{\text{D}} \cdot (1 - \zeta_{\text{Chl}} \hat{\theta})
  \left[ L_{\text{I}} - (1 - L_{\text{I}}) \frac{\alpha \cdot \bar{I}}{\hat{\mu}_{0}} \hat{\theta} \right] \qquad
  \frac{\partial Z}{\partial \hat{V}_{0}} = -\hat{\mu}_{\text{net}} \frac{Q_{0}}{2 \hat{\mu}_{0} \sqrt{\hat{\mu}_{0} \cdot \hat{V}_{\text{N}}}} \\
  \frac{1}{f(T)} \frac{\text{d}\,f(T)}{\text{d}\,T} &= \frac{E_{\text{a}}}{R\cdot {(T / \text{K})}^{2}}
\end{flalign}

We would like to clarify that
%(1) the DIN in the denominator in the solution provided by S16 (their Eq.~A-5) was a typo;
(1) replacement of $\hat{\mu}_g$ (in S16, $\hat{\mu}^I$) with $\hat{\mu}_{\text{net}}$ in our model (see K21) results in the appearance of $(1-\hat{\theta} \cdot \zeta_{\text{Chl}})$ when computing $\partial \hat{\mu}_{\text{net}} / \partial \bar{I}$;
(2) $L_{\text{D}}$ used to be implicit in S16, now it's explicit (K21 Eq.~21) therefore it appears for $\partial\hat{\mu}_{\text{net}} / \partial \bar{I}$ unlike in S16; (3) Changes in $Q$ due to T were not accounted for by \citet{Smith2016}.

% \section{Relevance of changes in quota for the loss processes}\label{S:appQ4loss}  %% Appendix-A
% \onur{Not sure whether we want to keep this}
% %In our model, we considered a single loss process for phytoplankton.
% %Recalling from K21 (Table 1) that the associated N flux term was expressed as
% %\begin{flalign}
% % F_{\text{Phy}_{\text{N}}-\text{Det}_{\text{N}}} &= m \cdot \text{Phy}_{\text{N}}^2 &&
% %\end{flalign}
% %and considering that $\text{Phy}_{\text{N}}=\text{Phy}_{\text{C}} \cdot Q$, it can be thought that the changes in $Q$ needs to be taken into account for calculating the flux between phytoplankton and detrital N due to mortality.
% Potential links between cellular quotas and loss processes can be assessed by analyzing the components of the changes in $\text{Phy}_{\text{N}}$ occurring due to loss terms, as was previously done for the case of growth (Eq.~\eqref{eq:dphyNdt}). Observing that the only loss process we considered here is mortality:
% \begin{flalign}
%   \frac{\text{d}\,\text{Phy}_{\text{N}}}{\text{d}\,t} \bigg\rvert_L
%   &=\frac{\text{d}\,\text{Phy}_{\text{C}} Q}{\text{d}\,t} \bigg\rvert_M
%   = Q \frac{\text{d}\,\text{Phy}_{\text{C}}}{\text{d}\,t} \bigg\rvert_M + \text{Phy}_{\text{N}}\frac{\text{d}\,\text{Q}_{\text{N}}}{\text{d}\,t} \bigg\rvert_M
% \end{flalign}
% Here, in the first term, $\frac{\text{d}\,\text{Phy}_{\text{C}}}{\text{d}\,t} \rvert_M$ represents the C-based mortality rate ($=m \cdot \text{Phy}_{\text{C}}^2$, Eq.~\eqref{eq:mortC}). In the second term, $\frac{\text{d}\,\text{Q}_{\text{N}}}{\text{d}\,t} \rvert_M$ represents the changes occurring in $Q$, however, due to mortality only. As in our model, we did not consider any effect of mortality on quota (assuming that when a cell dies, it dies altogether and all of its contents become detritus), this term collapses to 0, therefore reducing the associated flux term to:
% \begin{flalign}
% F_{\text{Phy}_{\text{N}}-\text{Det}_{\text{N}}} &=
% Q \frac{\text{d}\,\text{Phy}_{\text{C}}}{\text{d}\,t} \bigg\rvert_M = Q \cdot m \cdot \text{Phy}_{\text{C}}^2
% \end{flalign}
% However, in any other model that may consider processes that may affect the cellular quotas, such as excretion of C-rich, N-poor substances, associated consequences on various elemental fluxes can be taken into account following this framework.

% \section{On the differences between the IA and DA variants}\label{S:appIADA}  %% Appendix-B
% \onur{Markus, would you like to draft this section?}

\noappendix%% use this to mark the end of the appendix section. Otherwise the figures might be numbered incorrectly (e.g., 10 instead of 1).

%% Regarding figures and tables in appendices, the following two options are possible depending on your general handling of figures and tables in the manuscript environment:

%% Option 1: If you sorted all figures and tables into the sections of the text, please also sort the appendix figures and appendix tables into the respective appendix sections.
%% They will be correctly named automatically.

%% Option 2: If you put all figures after the reference list, please insert appendix tables and figures after the normal tables and figures.
%% To rename them correctly to A1, A2, etc., please add the following commands in front of them:

%\appendixfigures%% needs to be added in front of appendix figures

%\appendixtables%% needs to be added in front of appendix tables

%% Please add \clearpage between each table and/or figure. Further guidelines on figures and tables can be found below.

\authorcontribution{OK and SLS conceived and designed the study with contributions from MP; OK and MP extended the model with fluxes required to satisfy the mass balance; OK implemented the model in FABM\@; PA configured and performed the runs with multiple PFTs; OK drafted the manuscript; MP and SLS contributed to writing and revision of the text.
%\onur{anything I might have missed?}
} %% this section is mandatory

%\competinginterests{No competing interests are present.} %% this section is mandatory even if you declare that no competing interests are present

%\disclaimer{TEXT} %% optional section

\begin{acknowledgements}
This research has been supported by the German Research Foundation, DFG (grant no. KE 1970/2-1, PI\@: OK), the Japan Society for the Promotion of Science, JSPS (PI\@: SLS). %\onur{any other financial support statements needed?}
We acknowledge the developers of the open-source software used in this study, foremost FABM and GOTM\@.
\end{acknowledgements}


%% REFERENCES

%% The reference list is compiled as follows:

% \begin{thebibliography}{}
%
% \bibitem[AUTHOR(YEAR)]{LABEL1}
% REFERENCE 1
%
% \bibitem[AUTHOR(YEAR)]{LABEL2}
% REFERENCE 2
%
% \end{thebibliography}

%% Since the Copernicus LaTeX package includes the BibTeX style file copernicus.bst,
%% authors experienced with BibTeX only have to include the following two lines:
%%
\bibliographystyle{copernicus}
\bibliography{NflexPD_2_0.bib}
%%
%% URLs and DOIs can be entered in your BibTeX file as:
%%
%% URL = {http://www.xyz.org/~jones/idx_g.htm}
%% DOI = {10.5194/xyz}


%% LITERATURE CITATIONS
%%
%% command                        & example result
%% \citet{jones90}|               & Jones et al. (1990)
%% \citep{jones90}|               & (Jones et al., 1990)
%% \citep{jones90,jones93}|       & (Jones et al., 1990, 1993)
%% \citep[p.~32]{jones90}|        & (Jones et al., 1990, p.~32)
%% \citep[e.g.,][]{jones90}|      & (e.g., Jones et al., 1990)
%% \citep[e.g.,][p.~32]{jones90}| & (e.g., Jones et al., 1990, p.~32)
%% \citeauthor{jones90}|          & Jones et al.
%% \citeyear{jones90}|            & 1990



%% FIGURES

%% When figures and tables are placed at the end of the MS (article in one-column style), please add \clearpage
%% between bibliography and first table and/or figure as well as between each table and/or figure.

% The figure files should be labelled correctly with Arabic numerals (e.g., fig01.jpg, fig02.png).


%% ONE-COLUMN FIGURES

%%f
%\begin{figure}[t]
%\includegraphics[width=8.3cm]{FILE NAME}
%\caption{TEXT}
%\end{figure}
%
%%% TWO-COLUMN FIGURES
%
%%f
%\begin{figure*}[t]
%\includegraphics[width=12cm]{FILE NAME}
%\caption{TEXT}
%\end{figure*}
%
%
%%% TABLES
%%%
%%% The different columns must be separated with a & command and should
%%% end with \\ to identify the column brake.
%
%%% ONE-COLUMN TABLE
%
%%t
%\begin{table}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{table}
%
%%% TWO-COLUMN TABLE
%
%%t
%\begin{table*}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{table*}
%
%%% LANDSCAPE TABLE
%
%%t
%\begin{sidewaystable*}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{sidewaystable*}
%
%
%%% MATHEMATICAL EXPRESSIONS
%
%%% All papers typeset by Copernicus Publications follow the math typesetting regulations
%%% given by the IUPAC Green Book (IUPAC: Quantities, Units and Symbols in Physical Chemistry,
%%% 2nd Edn., Blackwell Science, available at: http://old.iupac.org/publications/books/gbook/green_book_2ed.pdf, 1993).
%%%
%%% Physical quantities/variables are typeset in italic font (t for time, T for Temperature)
%%% Indices which are not defined are typeset in italic font (x, y, z, a, b, c)
%%% Items/objects which are defined are typeset in roman font (Car A, Car B)
%%% Descriptions/specifications which are defined by itself are typeset in roman font (abs, rel, ref, tot, net, ice)
%%% Abbreviations from 2 letters are typeset in roman font (RH, LAI)
%%% Vectors are identified in bold italic font using \vec{x}
%%% Matrices are identified in bold roman font
%%% Multiplication signs are typeset using the LaTeX commands \times (for vector products, grids, and exponential notations) or \cdot
%%% The character * should not be applied as multiplication sign
%
%
%%% EQUATIONS
%
%%% Single-row equation
%
%\begin{equation}
%
%\end{equation}
%
%%% Multiline equation
%
%\begin{align}
%& 3 + 5 = 8\\
%& 3 + 5 = 8\\
%& 3 + 5 = 8
%\end{align}
%
%
%%% MATRICES
%
%\begin{matrix}
%x & y & z\\
%x & y & z\\
%x & y & z\\
%\end{matrix}
%
%
%%% ALGORITHM
%
%\begin{algorithm}
%\caption{...}
%\label{a1}
%\begin{algorithmic}
%...
%\end{algorithmic}
%\end{algorithm}
%
%
%%% CHEMICAL FORMULAS AND REACTIONS
%
%%% For formulas embedded in the text, please use \chem{}
%
%%% The reaction environment creates labels including the letter R, i.e. (R1), (R2), etc.
%
%\begin{reaction}
%%% \rightarrow should be used for normal (one-way) chemical reactions
%%% \rightleftharpoons should be used for equilibria
%%% \leftrightarrow should be used for resonance structures
%\end{reaction}
%
%
%%% PHYSICAL UNITS
%%%
%%% Please use \unit{} and apply the exponential notation

\end{document}

% Local Variables:
% TeX-engine: default
% End:
